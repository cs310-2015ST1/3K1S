{% load staticfiles %}

<link rel="stylesheet" type="text/css" href="{% static 'liquor_locator/style.css' %}" />

<!DOCTYPE html>
<html>
    <head>
        <script src="https://maps.googleapis.com/maps/api/js"></script>
        <script>
        var user = 'http://www.robotwoods.com/dev/misc/bluecircle.png';
        var myLat;
        var myLon;
        var storelist = new Array();
        
        /*
        * storelist = array of store info(name, lat, lon, store type)
        * sets storelist
        */
        function getAllStores(){
            var i = 0;
            {% for store in liquorstores %}
            var eachStore = ['{{store.name}}', '{{store.lat}}', '{{store.lon}}', '{{store.storetype}}'];
            storelist[i] = eachStore;
            i++;
            {% endfor %}
        }

        /*
        * Finds geolocation of user's location through Browser
        */
        function geoFindMe(){
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(success, error, geo_options);

            }else{
                alert("Geolocation services are not supported by your web browser.");
            }
            
            function success(position) {
                myLat = position.coords.latitude;
                myLon = position.coords.longitude;
                var altitude = position.coords.altitude;
                var accuracy = position.coords.accuracy;

                initialize(myLat, myLon);
            }

            function error(error) {
                alert("Unable to retrieve your location due to "+error.code + " : " + error.message);
            };
            var geo_options = {
                enableHighAccuracy: true,
                maximumAge : 30000,
                timeout : 27000
            };
        }

        /*
        * Initialization of google map, with user location and storelist from getAllStores();
        */
        function initialize(latitude, longitude){
            //Creates a list of stores
            getAllStores();
            
            //Google Map initialization
            var mapCanvas = document.getElementById('map-canvas');
            var myLatLon = new google.maps.LatLng(latitude, longitude);
            var mapOptions={
                center: myLatLon,
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            var map = new google.maps.Map(mapCanvas, mapOptions);
            
            var userMarker = new google.maps.Marker({
                position: myLatLon,
                map: map,
                icon: user,
            });

            var infowindow = new google.maps.InfoWindow();
            var marker, i;
            for (i = 0; i < storelist.length; i++) {  
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(storelist[i][1], storelist[i][2]),
                    map: map
                });
                google.maps.event.addListener(marker, 'click', (function(marker, i) {
                    return function() {
                        infowindow.setContent(storelist[i][0]);
                        infowindow.open(map, marker);
                    }
                })(marker, i));
            }
        }

        </script>
        <title> 3K1S </title>
    </head>
    <body onload="geoFindMe()">
        <div id = "header">
            <div class = "container">
                <div id = "logoArea"></div>
                <div id = "navArea">
                    <ul id = "nav">
                        <a href = "#"><li>Home</li></a>
                        <a href = "#"><li>Log-In</li></a>
                        <a href="/liquor_locator/about/"><li>About</li></a>
                    </ul>
                </div>
            </div>
        </div>
        <div id = "mainArea">
            <div class = "container page">
                <div id="map-canvas"></div>
            </div>
        </div>
    </body>
</html>
